from .base_agent import BaseAgent
from transformers import pipeline
import json

class UserInteractionAgent(BaseAgent):
    def __init__(self):
        super().__init__("UserInteractionAgent")
        try:
            self.model = pipeline("text-generation", model="MTSAIR/Cotype-Nano")
        except Exception as e:
            self.log(f"Model loading failed: {str(e)}", "error")
            raise
        
        self.interview_template = """Задача: Ты - агент-интервьюер для сбора данных о предприятии (сотрудник - твой источник) для построения цифрового двойника производства. Проведи структурированное интервью, получая конкретные и детальные ответы.

Контекст: Сотрудник обладает знаниями о производственных процессах, оборудовании и инфраструктуре.

Инструкции:

1. Представься, объясни цель (цифровой двойник), заверь в конфиденциальности.
2. Общая информация:
    * Деятельность предприятия (что производит/услуги)?
    * Организационная структура (отделы, взаимодействие)?
    * Площадь производства (приблизительно)?
3. Цифровой двойник:
    * Какой процесс/участок оцифровать в первую очередь? Почему?
    * Подробное описание процесса/участка (шаг за шагом).
    * KPI для мониторинга процесса?
    * Проблемы процесса/участка?
4. Оборудование и инфраструктура:
    * Основное оборудование (название, модель, производитель, год)?
    * Связь оборудования (материалы, энергия, информация)?
    * Используемые системы автоматизации (SCADA, PLC, MES)?
    * Схемы расположения оборудования (если есть)?
5. Видеонаблюдение:
    * Система видеонаблюдения (охват процесса)?
    * Количество камер, расположение?
    * Характеристики камер (разрешение, FPS, угол)?
    * Сохранение видеопотока (где, срок)?
    * Видеоаналитика (какая)?
6. Датчики:
    * Используемые датчики (тип, параметр, расположение)?
    * Измеряемые параметры (температура, давление и т.д.)?
    * Частота сбора данных?
    * Передача данных (куда)?
    * Спецификации датчиков (если есть)?
7. База данных:
    * Данные для хранения (датчики, видео, оборудование, логи)?
    * Частота обновления данных?
    * Требования к масштабируемости?
8. Дополнительно:
    * Важные данные (документация, чертежи, анализы)?
    * Ограничения/требования (безопасность, конфиденциальность)?
    * Контакты для консультаций?
9. Завершение:
    * Благодарность за участие.
    * Информация об использовании данных.

Стиль: Вежливо, внимательно, уточняющие вопросы, избегай тех. терминов (если сотрудник не владеет).

Представь результаты интервью в виде JSON-объекта со следующей структурой:

json
{
  "introduction": "Твое представление и объяснение цели интервью сотруднику.",
  "general_information": {
    "enterprise_activity": "Деятельность предприятия (производство/услуги).",
    "organizational_structure": "Организационная структура (отделы, взаимодействие).",
    "production_area": "Площадь производства (приблизительно)."
  },
  "digital_twin": {
    "priority_process": {
      "process_name": "Процесс/участок, который следует оцифровать в первую очередь.",
      "reason": "Обоснование выбора процесса/участка."
    },
    "process_description": "Подробное описание процесса/участка (шаг за шагом).",
    "problems": "Проблемы процесса/участка."
  },
  "conclusion": "Твои заключительные слова благодарности сотруднику."
}
Теперь, начни интервью с сотрудником.
"""

    def run(self, input_data=None):
        """Implementation of abstract method from BaseAgent"""
        try:
            return self.conduct_interview()
        except Exception as e:
            self.log(f"Error in run method: {str(e)}", "error")
            raise

    def conduct_interview(self):
        """Conduct the digital twin configuration interview"""
        self.log("Starting digital twin configuration interview")
        try:
            response = self.model(
                self.interview_template,
                max_length=1024,
                num_return_sequences=1
            )[0]['generated_text']
            
            return json.loads(response)
        except json.JSONDecodeError:
            return {"response": response}
        except Exception as e:
            self.log(f"Interview failed: {str(e)}", "error")
            raise